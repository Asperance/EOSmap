<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>EOS Map (—Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)</title>
  
  <!-- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <!-- –ü–ª–∞–≥–∏–Ω Leaflet‚ÄëGeoman -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@geoman-io/leaflet-geoman-free@2.15.0/dist/leaflet-geoman.css" />

  <style>
    html,body,#map{height:100%;margin:0;background:#111}
    .leaflet-container{background:#111}
    .label-no-bg{background:transparent!important;border:none!important;padding:0!important;pointer-events:none;}
  </style>
</head>
<body>
<div id="map"></div>

<!-- –°–∫—Ä–∏–ø—Ç—ã -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/@geoman-io/leaflet-geoman-free@2.15.0/dist/leaflet-geoman.min.js" defer></script>
<script defer>
window.addEventListener('load', () => {
  const MAP_IMG = 'img/map.png';              // —Ñ–∞–π–ª –ø–æ–¥–ª–æ–∂–∫–∏ –∫–∞—Ä—Ç—ã
  const ICON_MANIFEST = 'img/icons.json';     // JSON‚Äë—Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∏–∫–æ–Ω–æ–∫

  /* === –¶–≤–µ—Ç–æ–≤–∞—è –ø–∏–ø–µ—Ç–∫–∞ (–≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç Promise<HEX>) === */
  const pickColor = (def = '#ffffff') => new Promise(res => {
    const input = Object.assign(document.createElement('input'), { type:'color', value:def, style:'position:fixed;left:-999px' });
    document.body.appendChild(input);
    input.addEventListener('input', () => { res(input.value); document.body.removeChild(input); });
    input.click();
  });

  /* === –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –∏–∫–æ–Ω–æ–∫ === */
  let iconList = [];
  fetch(ICON_MANIFEST).then(r=>r.ok?r.json():[]).then(arr=> iconList = arr).catch(()=>{});

  /* === –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É‚Äë–ø–æ–¥–ª–æ–∂–∫—É –∏ —Å–æ–∑–¥–∞—ë–º –∫–∞—Ä—Ç—É === */
  const img = new Image();
  img.onload = () => {
    const bounds = [[0,0],[img.naturalHeight,img.naturalWidth]];
    const map = L.map('map', { crs:L.CRS.Simple, minZoom:-5, maxZoom:2, zoomSnap:0.5 });
    L.imageOverlay(MAP_IMG, bounds).addTo(map);
    map.fitBounds(bounds); map.zoomIn(1); map.setMaxBounds(bounds);

    // === –ü–ê–ù–ï–õ–¨ –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø === (–∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ —Å—Ç—Ä–æ–∫—É –Ω–∏–∂–µ –¥–ª—è —Ä–µ–∂–∏–º–∞ –¢–û–õ–¨–ö–û –ü–†–û–°–ú–û–¢–†)
    map.pm.addControls({ position:'topleft', drawMarker:true, drawCircle:true, drawPolygon:true, editMode:true, dragMode:true, removalMode:true });

    /* ---------- –ü–∞–ª–∏—Ç—Ä–∞ –∏–∫–æ–Ω–æ–∫ (—Å–ø—Ä–∞–≤–∞‚Äë–≤–≤–µ—Ä—Ö—É) ---------- */
    let currentIconUrl = '', currentNatural = [32,32];
    const IconPalette = L.Control.extend({
      options:{ position:'topright' },
      onAdd(){
        const div = L.DomUtil.create('div','leaflet-bar leaflet-control');
        div.style.cssText = 'background:#222;padding:4px;max-height:160px;overflow-y:auto';
        iconList.forEach(file => {
          const imgEl = new Image(); imgEl.src = 'img/'+file;
          imgEl.onload = () => { if(currentIconUrl === '') highlight(imgEl); };
          imgEl.style.cssText = 'width:24px;height:24px;margin:2px;cursor:pointer;';
          imgEl.onclick = () => highlight(imgEl);
          div.appendChild(imgEl);
        });
        function highlight(imgEl){
          currentIconUrl = imgEl.src;
          currentNatural = [imgEl.naturalWidth||32, imgEl.naturalHeight||32];
          [...div.children].forEach(c=>c.style.outline='none');
          imgEl.style.outline='2px solid #0f0';
        }
        return div;
      }
    });
    map.addControl(new IconPalette());

    /* ---------- –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ ---------- */
    map.on('pm:create', async e => {
      const layer = e.layer;

      /* --- –ó–û–ù–´ (–∫—Ä—É–≥ / –ø–æ–ª–∏–≥–æ–Ω) --- */
      if(layer instanceof L.Circle || layer instanceof L.Polygon){
        const col = await pickColor('#ff0000');
        layer.setStyle({ color:col, fillColor:col, fillOpacity:0.3 });
        saveProps(layer,{color:col});
        return;
      }

      /* --- –ú–ê–†–ö–ï–†–´ --- */
      if(layer instanceof L.Marker){
        // 1) —Ä–∞–∑–º–µ—Ä –∏–∫–æ–Ω–∫–∏
        let size = [...currentNatural];
        const w = prompt('–®–∏—Ä–∏–Ω–∞ –∏–∫–æ–Ω–∫–∏ (px, Enter = –æ—Ä–∏–≥–∏–Ω–∞–ª):','');
        const h = prompt('–í—ã—Å–æ—Ç–∞ –∏–∫–æ–Ω–∫–∏ (px, Enter = –æ—Ä–∏–≥–∏–Ω–∞–ª):','');
        if(w && h){ size = [parseInt(w)||size[0], parseInt(h)||size[1]]; }
        layer.setIcon(L.icon({ iconUrl: currentIconUrl, iconSize: size, iconAnchor:[size[0]/2,size[1]] }));

        // 2) –ø–æ–¥–ø–∏—Å—å
        const label = prompt('–¢–µ–∫—Å—Ç –ø–æ–¥–ø–∏—Å–∏ (Enter ‚Äî –±–µ–∑ –ø–æ–¥–ø–∏—Å–∏):','');
        let color = '#ffffff', fontSize='14', stroke='2';
        if(label){
          color    = await pickColor('#ffffff');
          fontSize = prompt('–†–∞–∑–º–µ—Ä —Ç–µ–∫—Å—Ç–∞ (px):','14')||'14';
          stroke   = prompt('–¢–æ–ª—â–∏–Ω–∞ –±–µ–ª–æ–π –æ–±–≤–æ–¥–∫–∏ (px, 0 = –±–µ–∑):','2')||'0';
          layer.bindTooltip(label, { permanent:true, direction:'center', className:'label-no-bg', opacity:1, offset:[0,size[1]/2] }).openTooltip();
          styleTooltip(layer.getTooltip(), color, fontSize, stroke);
        }
        saveProps(layer,{ icon:currentIconUrl, iconW:size[0], iconH:size[1], label, labelColor:color, labelSize:fontSize, labelStroke:stroke });
      }
    });

    /* ---------- –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ ---------- */
    fetch('data/features.json').then(r=>r.ok?r.json():null).then(json => {
      if(!json) return;
      L.geoJSON(json, {
        pointToLayer:(f,latlng) => {
          if(f.properties && f.properties.icon){
            const sz = [f.properties.iconW||32, f.properties.iconH||32];
            return L.marker(latlng,{ icon:L.icon({iconUrl:f.properties.icon,iconSize:sz,iconAnchor:[sz[0]/2,sz[1]]}) });
          }
          return L.marker(latlng);
        },
        onEachFeature:(f,l) => {
          if(f.properties){
            if(l.setStyle && f.properties.color){ l.setStyle({color:f.properties.color,fillColor:f.properties.color,fillOpacity:0.3}); }
            if(l instanceof L.Marker && f.properties.label){
              const szH = f.properties.iconH || 32;
              l.bindTooltip(f.properties.label,{permanent:true,direction:'center',className:'label-no-bg',opacity:1,offset:[0,szH/2]}).openTooltip();
              styleTooltip(l.getTooltip(), f.properties.labelColor, f.properties.labelSize, f.properties.labelStroke);
            }
          }
        }
      }).addTo(map);
    });

    /* ---------- –ö–Ω–æ–ø–∫–∞ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å ---------- */
    L.control({position:'topleft'}).onAdd = () => {
      const div = L.DomUtil.create('div','leaflet-bar leaflet-control');
      div.innerHTML = '<a href="#" title="–°–∫–∞—á–∞—Ç—å features.json">üíæ</a>';
      div.style.cursor='pointer';
      div.onclick = e => { e.preventDefault(); downloadJSON(L.featureGroup(L.PM.Utils.findLayers(map)).toGeoJSON()); };
      return div;
    };

    /* === –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò === */
    function styleTooltip(tt, color, size, stroke){
      const el = tt && tt.getElement ? tt.getElement() : null; if(!el) return;
      if(color) el.style.color = color;
      if(size)  el.style.fontSize = size+'px';
      if(stroke && parseInt(stroke)>0){ el.style.webkitTextStroke=`${stroke}px #fff`; } else { el.style.webkitTextStroke=''; }
      el.style.textShadow='0 0 2px #000';
