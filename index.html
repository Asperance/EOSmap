<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>EOS Map ‚Äî —Ä–µ–¥–∞–∫—Ç–æ—Ä</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <!-- Leaflet-Geoman -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@geoman-io/leaflet-geoman-free@2.15.0/dist/leaflet-geoman.css" />

  <style>
    /* –û–±—â–µ–µ */
    html,body,#map{height:100%;margin:0;background:#111}
    .leaflet-container{background:#111}

    /* –ü–æ–¥–ø–∏—Å—å –±–µ–∑ —Ñ–æ–Ω–∞ */
    .label-no-bg{background:transparent!important;border:none!important;padding:0!important;pointer-events:none;white-space:nowrap;}

    /* –ü–∞–ª–∏—Ç—Ä–∞ –∏–∫–æ–Ω–æ–∫ */
    .icon-box{background:#222;padding:4px;max-height:160px;overflow-y:auto}
    .icon-box img{width:24px;height:24px;margin:2px;cursor:pointer;outline:none}
    .icon-box img.sel{outline:2px solid #0f0}
  </style>
</head>
<body>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/@geoman-io/leaflet-geoman-free@2.15.0/dist/leaflet-geoman.min.js" defer></script>
<script defer>
/* ====================== –ù–ê–°–¢–†–û–ô–ö–ò ====================== */
const MAP_IMG    = 'img/map.png';     // –ø–æ–¥–ª–æ–∂–∫–∞ –∫–∞—Ä—Ç—ã
const ICONS_JSON = 'img/icons.json';  // —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ –∏–∫–æ–Ω–æ–∫
const STROKE_PX  = 2;                 // —Ç–æ–ª—â–∏–Ω–∞ –±–µ–ª–æ–π –æ–±–≤–æ–¥–∫–∏ —Ç–µ–∫—Å—Ç–∞

/* ====================================================== */
window.addEventListener('load',()=>{
  /* ------- –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ------- */
  let baseZoom = 0;                // –∑—É–º, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–º –±—Ä–∞–ª–∏—Å—å ¬´–±–∞–∑–æ–≤—ã–µ¬ª —Ä–∞–∑–º–µ—Ä—ã
  const labels  = [];              // [{el, baseSize}]
  const markers = [];              // [{layer, baseW, baseH}]
  let curIcon = {url:'', w:32, h:32};

  /* ------- –∑–∞–≥—Ä—É–∂–∞–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É –∫–∞—Ä—Ç—ã ------- */
  const img = new Image();
  img.onload = ()=>fetch(ICONS_JSON).then(r=>r.ok?r.json():[]).then(list=>init(img,list)).catch(()=>init(img,[]));
  img.src = MAP_IMG;

  /* ------- –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã ------- */
  function init(img, iconList){
    const bounds = [[0,0],[img.naturalHeight,img.naturalWidth]];
    const map = L.map('map',{crs:L.CRS.Simple,minZoom:-5,maxZoom:2});
    baseZoom = map.getZoom();
    L.imageOverlay(MAP_IMG,bounds).addTo(map);
    map.fitBounds(bounds);
    map.setMaxBounds(bounds);

    /* === –ü–ê–ù–ï–õ–¨ –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø (–∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ —Å—Ç—Ä–æ–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –æ—Å—Ç–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ –ø—Ä–æ—Å–º–æ—Ç—Ä) === */
    map.pm.addControls({position:'topleft',drawMarker:true,drawCircle:true,drawPolygon:true,editMode:true,dragMode:true,removalMode:true});

    /* ------- –ø–∞–ª–∏—Ç—Ä–∞ –∏–∫–æ–Ω–æ–∫ ------- */
    if(iconList.length){
      const Palette = L.Control.extend({
        options:{position:'topright'},
        onAdd(){
          const box = L.DomUtil.create('div','leaflet-bar leaflet-control icon-box');
          iconList.forEach(f=>{
            const im = new Image();
            im.src = 'img/'+f;
            im.onload = ()=>{ if(!curIcon.url){select(im);} };
            im.onclick = ()=>select(im);
            box.appendChild(im);
          });
          function select(im){
            curIcon.url = im.src;
            curIcon.w   = im.naturalWidth  || 32;
            curIcon.h   = im.naturalHeight || 32;
            [...box.children].forEach(c=>c.classList.remove('sel'));
            im.classList.add('sel');
          }
          return box;
        }
      });
      map.addControl(new Palette());
    }

    /* ------- –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–∑–¥–∞–Ω–∏—è –æ–±—ä–µ–∫—Ç–æ–≤ ------- */
    map.on('pm:create', async ev=>{
      const layer = ev.layer;

      /* ----- –∫—Ä—É–≥ / –ø–æ–ª–∏–≥–æ–Ω ----- */
      if(layer instanceof L.Circle || layer instanceof L.Polygon){
        let col = prompt('HEX —Ü–≤–µ—Ç –∑–æ–Ω—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä ff0000):','#ff0000');
        if(!/^#?[0-9a-fA-F]{6}$/.test(col||'')) col = '#ff0000';
        if(col[0]!=='#') col = '#'+col;
        layer.setStyle({color:col,fillColor:col,fillOpacity:0.3});
        save(layer,{color:col});
        return;
      }

      /* ----- –º–∞—Ä–∫–µ—Ä ----- */
      if(layer instanceof L.Marker){
        /* –∑–∞–ø—Ä–æ—Å —Ä–∞–∑–º–µ—Ä–æ–≤ */
        let w = prompt('–®–∏—Ä–∏–Ω–∞ –∏–∫–æ–Ω–∫–∏ (px):',curIcon.w);
        let h = prompt('–í—ã—Å–æ—Ç–∞ –∏–∫–æ–Ω–∫–∏ (px):',curIcon.h);
        w = +w||curIcon.w; h = +h||curIcon.h;
        layer.setIcon(L.icon({iconUrl:curIcon.url,iconSize:[w,h],iconAnchor:[w/2,h]}));
        markers.push({layer, baseW:w, baseH:h});

        /* –ø–æ–¥–ø–∏—Å—å */
        const txt = prompt('–¢–µ–∫—Å—Ç –ø–æ–¥–ø–∏—Å–∏ (Enter = –±–µ–∑):','');
        if(txt){
          let size = prompt('–†–∞–∑–º–µ—Ä —Ç–µ–∫—Å—Ç–∞ (px):','14')||'14';
          let col  = prompt('HEX —Ü–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä ffffff):','#ffffff')||'#ffffff';
          if(col[0]!=='#') col='#'+col;
          if(!/^#?[0-9a-fA-F]{6}$/.test(col)) col = '#ffffff';
          layer.bindTooltip(txt,{permanent:true,direction:'center',className:'label-no-bg',offset:[0,h/2]}).openTooltip();
          styleTooltip(layer.getTooltip(),size,col);
          save(layer,{icon:curIcon.url,iconW:w,iconH:h,label:txt,labelSize:size,labelColor:col});
        }else{
          save(layer,{icon:curIcon.url,iconW:w,iconH:h});
        }
      }
    });

    /* ------- –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ ------ */
    map.on('zoomend',()=>{
      const factor = Math.pow(2,map.getZoom()-baseZoom);
      // –ø–æ–¥–ø–∏—Å–∏
      labels.forEach(o=>{
        o.el.style.fontSize = (o.baseSize*factor)+'px';
        o.el.style.webkitTextStroke = (STROKE_PX*factor)+'px #fff';
      });
      // –∏–∫–æ–Ω–∫–∏
      markers.forEach(m=>{
        const nw = m.baseW*factor;
        const nh = m.baseH*factor;
        m.layer.setIcon(L.icon({iconUrl:m.layer.options.icon.options.iconUrl,iconSize:[nw,nh],iconAnchor:[nw/2,nh]}));
        if(m.layer.getTooltip()){
          m.layer.getTooltip().options.offset=[0,nh/2];
          m.layer.update();
        }
      });
    });

    /* ------- –∑–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö —Å–ª–æ—ë–≤ ------- */
    fetch('data/features.json')
      .then(r=>r.ok?r.json():null)
      .then(gj=>{ if(!gj) return; L.geoJSON(gj,{
        pointToLayer:(f,latlng)=>{
          if(f.properties && f.properties.icon){
            const s=[f.properties.iconW||32,f.properties.iconH||32];
            const mk=L.marker(latlng,{icon:L.icon({iconUrl:f.properties.icon,iconSize:s,iconAnchor:[s[0]/2,s[1]]})});
            markers.push({layer:mk,baseW:s[0],baseH:s[1]});
            return mk;
          }
          return L.marker(latlng);
        },
        onEachFeature:(f,l)=>{
          if(f.properties && f.properties.color && l.setStyle){
            l.setStyle({color:f.properties.color,fillColor:f.properties.color,fillOpacity:0.3});
          }
          if(l instanceof L.Marker && f.properties && f.properties.label){
            const h=f.properties.iconH||32;
            l.bindTooltip(f.properties.label,{permanent:true,direction:'center',className:'label-no-bg',offset:[0,h/2]}).openTooltip();
            styleTooltip(l.getTooltip(),f.properties.labelSize,f.properties.labelColor);
          }
        }
      }).addTo(map); });

    /* ------- –∫–Ω–æ–ø–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è ------- */
    const Save=L.Control.extend({options:{position:'topleft'},onAdd(){
      const d=L.DomUtil.create('div','leaflet-bar leaflet-control');
      d.innerHTML='<a href="#" title="–°–∫–∞—á–∞—Ç—å features.json">üíæ</a>'; d.style.cursor='pointer';
      d.onclick=e=>{e.preventDefault(); downloadJSON(L.featureGroup(L.PM.Utils.findLayers(map)).toGeoJSON()); };
      return d;
    }});
    map.addControl(new Save());

    /* ------- helpers ------- */
    function styleTooltip(tt,size,col){
      const el = tt && tt.getElement ? tt.getElement() : null;
      if(!el) return;
      labels.push({el, baseSize:+size});
      el.style.fontSize = size+'px';
      el.style.color = col;
      el.style.webkitTextStroke = STROKE_PX+'px #fff'; /* –≤–Ω–µ—à–Ω—è—è –±–µ–ª–∞—è –æ–±–≤–æ–¥–∫–∞ */
      el.style.textShadow = '0 0 2px #000';
    }

    function save(layer,props={}){
      layer.feature = layer.feature||{type:'Feature',properties:{}};
      Object.assign(layer.feature.properties,props);
    }

    function downloadJSON(data){
      const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a');
      a.href=url; a.download='features.json'; a.click();
      URL.revokeObjectURL(url);
    }
  }
});
</script>
</body>
</html>
