<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>EOS Map (edit mode)</title>

  <!-- Leaflet core -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <!-- Leaflet-Geoman -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@geoman-io/leaflet-geoman-free@2.15.0/dist/leaflet-geoman.css" />

  <style>
    html,body,#map{height:100%;margin:0;background:#111}
    .leaflet-container{background:#111}
    .label-no-bg{background:transparent!important;border:none!important;padding:0!important;pointer-events:none;}
  </style>
</head>
<body>
<div id="map"></div>

<!-- libs -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/@geoman-io/leaflet-geoman-free@2.15.0/dist/leaflet-geoman.min.js" defer></script>
<script defer>
window.addEventListener('load',()=>{
  const imgSrc = 'img/map.png';
  const iconManifest = 'img/icons.json';

  /* Helper: system colorâ€‘picker â†’ Promise */
  const pickColor = (def='#ffffff')=>new Promise(res=>{const i=document.createElement('input');i.type='color';i.value=def;i.style.position='fixed';i.style.left='-100px';document.body.appendChild(i);i.click();i.addEventListener('input',()=>{res(i.value);document.body.removeChild(i);});});

  /* Load available icons */
  let iconList=[];
  fetch(iconManifest).then(r=>r.ok?r.json():[]).then(arr=>iconList=arr).catch(()=>{});

  /* Load map image */
  const img=new Image();img.onload=()=>{
    const bounds=[[0,0],[img.naturalHeight,img.naturalWidth]];
    const map=L.map('map',{crs:L.CRS.Simple,minZoom:-5,maxZoom:2,zoomSnap:0.5});
    L.imageOverlay(imgSrc,bounds).addTo(map);
    map.fitBounds(bounds);map.zoomIn(1);map.setMaxBounds(bounds);

    // === EDIT-MODE TOGGLE ===
    map.pm.addControls({position:'topleft',drawMarker:true,drawCircle:true,drawPolygon:true,editMode:true,dragMode:true,removalMode:true});

    /* ===== Icon palette ===== */
    let selIconUrl='',selIconNatural=[32,32],selCustomSize=null;
    map.addControl(L.Control.extend({onAdd(){const d=L.DomUtil.create('div','leaflet-bar leaflet-control');d.style.cssText='background:#222;padding:4px;max-height:160px;overflow-y:auto';iconList.forEach(f=>{const im=new Image();im.src='img/'+f;im.style.cssText='width:24px;height:24px;margin:2px;cursor:pointer;';im.onclick=()=>{selIconUrl='img/'+f;selIconNatural=[im.naturalWidth||32,im.naturalHeight||32];selCustomSize=null;[...d.children].forEach(c=>c.style.outline='none');im.style.outline='2px solid #0f0';};d.appendChild(im);});return d;}}));

    /* ===== Creation events ===== */
    map.on('pm:create',async e=>{
      const l=e.layer;
      /* ZONES */
      if(l instanceof L.Circle||l instanceof L.Polygon){
        const col=await pickColor('#ff0000');
        l.setStyle({color:col,fillColor:col,fillOpacity:0.3});
        l.feature=l.feature||{type:'Feature',properties:{}};l.feature.properties.color=col;
      }
      /* MARKERS */
      if(l instanceof L.Marker){
        if(selIconUrl){
          // Ask for custom size (blank = natural)
          const w=prompt('Ð¨Ð¸Ñ€Ð¸Ð½Ð° Ð¸ÐºÐ¾Ð½ÐºÐ¸ (px, Enter = Ð¾Ñ€Ð¸Ð³Ð¸Ð½Ð°Ð»):','');
          const h=prompt('Ð’Ñ‹ÑÐ¾Ñ‚Ð° Ð¸ÐºÐ¾Ð½ÐºÐ¸ (px, Enter = Ð¾Ñ€Ð¸Ð³Ð¸Ð½Ð°Ð»):','');
          if(w&&h){selCustomSize=[parseInt(w,10)||selIconNatural[0],parseInt(h,10)||selIconNatural[1]];} 
          const size=selCustomSize||selIconNatural;
          l.setIcon(L.icon({iconUrl:selIconUrl,iconSize:size,iconAnchor:[size[0]/2,size[1]]}));
        }
        const label=prompt('Ð¢ÐµÐºÑÑ‚ Ð¼ÐµÑ‚ÐºÐ¸ (Enter â€” Ð±ÐµÐ· Ð¿Ð¾Ð´Ð¿Ð¸ÑÐ¸):','');
        let txtColor='#ffffff',txtSize='14',strokeW='2';
        if(label){
          txtColor=await pickColor('#ffffff');
          txtSize =prompt('Ð Ð°Ð·Ð¼ÐµÑ€ Ñ‚ÐµÐºÑÑ‚Ð° (px):','14')||'14';
          strokeW =prompt('Ð¢Ð¾Ð»Ñ‰Ð¸Ð½Ð° Ð¾Ð±Ð²Ð¾Ð´ÐºÐ¸ (px, 0 = Ð±ÐµÐ·):','2')||'2';
          l.bindTooltip(label,{permanent:true,direction:'center',className:'label-no-bg',opacity:1,offset:[0,(selCustomSize?selCustomSize[1]:selIconNatural[1])/2]}).openTooltip();
          const el=l.getTooltip().getElement();
          if(el){
            el.style.color=txtColor;el.style.fontSize=txtSize+'px';
            if(parseInt(strokeW,10)>0){el.style.webkitTextStroke=`${strokeW}px #fff`;}
            el.style.textShadow='0 0 2px #000';
          }
        }
        l.feature=l.feature||{type:'Feature',properties:{}};
        Object.assign(l.feature.properties,{icon:selIconUrl||undefined,iconW:(selCustomSize||selIconNatural)[0],iconH:(selCustomSize||selIconNatural)[1],label,labelColor:txtColor,labelSize:txtSize,labelStroke:strokeW});
      }
    });

    /* ===== Load saved ===== */
    fetch('data/features.json').then(r=>r.ok?r.json():null).then(g=>{if(!g)return;L.geoJSON(g,{pointToLayer:(f,latlng)=>{if(f.properties&&f.properties.icon){return L.marker(latlng,{icon:L.icon({iconUrl:f.properties.icon,iconSize:[f.properties.iconW,f.properties.iconH],iconAnchor:[f.properties.iconW/2,f.properties.iconH]})});}return L.marker(latlng);},onEachFeature:(f,l)=>{if(f.properties){if(l.setStyle&&f.properties.color){l.setStyle({color:f.properties.color,fillColor:f.properties.color,fillOpacity:0.3});}if(l instanceof L.Marker&&f.properties.label){l.bindTooltip(f.properties.label,{permanent:true,direction:'center',className:'label-no-bg',opacity:1,offset:[0,(f.properties.iconH||32)/2]}).openTooltip();const el=l.getTooltip().getElement();if(el){if(f.properties.labelColor)el.style.color=f.properties.labelColor;if(f.properties.labelSize)el.style.fontSize=f.properties.labelSize+'px';if(f.properties.labelStroke&&parseInt(f.properties.labelStroke,10)>0){el.style.webkitTextStroke=`${f.properties.labelStroke}px #fff`;}}}}}).addTo(map);});

    /* ===== Save ===== */
    L.control({position:'topleft'}).onAdd=()=>{const d=L.DomUtil.create('div','leaflet-bar leaflet-control');d.innerHTML='<a href="#" title="Save">ðŸ’¾</a>';d.style.cursor='pointer';d.onclick=e=>{e.preventDefault();const coll=L.featureGroup(L.PM.Utils.findLayers(map)).toGeoJSON();const blob=new Blob([JSON.stringify(coll,null,2)],{type:'application/json'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='features.json';document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(url);};return d;};
  };
  img.src=imgSrc;
});
</script>
</body>
</html>
