<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>EOS Map (—Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)</title>
  
  <!-- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <!-- –ü–ª–∞–≥–∏–Ω Leaflet‚ÄëGeoman -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@geoman-io/leaflet-geoman-free@2.15.0/dist/leaflet-geoman.css" />

  <style>
    html,body,#map{height:100%;margin:0;background:#111}
    .leaflet-container{background:#111}
    .label-no-bg{background:transparent!important;border:none!important;padding:0!important;pointer-events:none;}
  </style>
</head>
<body>
<div id="map"></div>

<!-- –°–∫—Ä–∏–ø—Ç—ã -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/@geoman-io/leaflet-geoman-free@2.15.0/dist/leaflet-geoman.min.js" defer></script>
<script defer>
window.addEventListener('load', () => {
  /* =================== –ù–ê–°–¢–†–û–ô–ö–ò =================== */
  const MAP_IMG       = 'img/map.png';      // —Ñ–∞–π–ª –ø–æ–¥–ª–æ–∂–∫–∏ –∫–∞—Ä—Ç—ã
  const ICON_MANIFEST = 'img/icons.json';   // JSON‚Äë—Å–ø–∏—Å–æ–∫ –∏–∫–æ–Ω–æ–∫

  /* === –§—É–Ω–∫—Ü–∏—è –≤—ã–±–æ—Ä–∞ —Ü–≤–µ—Ç–∞ —á–µ—Ä–µ–∑ —Å–∏—Å—Ç–µ–º–Ω—É—é –ø–∞–ª–∏—Ç—Ä—É === */
  const pickColor = (def='#ffffff') => new Promise(res=>{
    const input = Object.assign(document.createElement('input'),{type:'color',value:def,style:'position:fixed;left:-999px'});
    document.body.appendChild(input);
    input.addEventListener('input',()=>{res(input.value);document.body.removeChild(input);});
    input.click();
  });

  /* === –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –∏–∫–æ–Ω–æ–∫ === */
  let iconList=[];
  fetch(ICON_MANIFEST).then(r=>r.ok?r.json():[]).then(arr=>iconList=arr).catch(()=>{});

  /* === –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã === */
  const img=new Image();
  img.onload=()=>initMap(img);
  img.src=MAP_IMG;

  /* === –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ === */
  function initMap(img){
    const mapBounds=[[0,0],[img.naturalHeight,img.naturalWidth]];
    const map=L.map('map',{crs:L.CRS.Simple,minZoom:-5,maxZoom:2,zoomSnap:0.5});
    L.imageOverlay(MAP_IMG,mapBounds).addTo(map);
    map.fitBounds(mapBounds);map.zoomIn(1);map.setMaxBounds(mapBounds);

    // ===== –ü–ê–ù–ï–õ–¨ –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø =====
    // –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ —Å—Ç—Ä–æ–∫—É –Ω–∏–∂–µ –¥–ª—è —Ä–µ–∂–∏–º–∞ ¬´—Ç–æ–ª—å–∫–æ –ø—Ä–æ—Å–º–æ—Ç—Ä¬ª
    map.pm.addControls({position:'topleft',drawMarker:true,drawCircle:true,drawPolygon:true,editMode:true,dragMode:true,removalMode:true});

    /* ---------- –ü–∞–ª–∏—Ç—Ä–∞ –∏–∫–æ–Ω–æ–∫ ---------- */
    let curIconUrl='',curNatural=[32,32];
    const IconPalette=L.Control.extend({options:{position:'topright'},onAdd(){
      const div=L.DomUtil.create('div','leaflet-bar leaflet-control');
      div.style.cssText='background:#222;padding:4px;max-height:160px;overflow-y:auto';
      iconList.forEach(f=>{
        const im=new Image();im.src='img/'+f;im.onload=()=>{if(!curIconUrl) select(im);};
        im.style.cssText='width:24px;height:24px;margin:2px;cursor:pointer;';
        im.onclick=()=>select(im);
        div.appendChild(im);
        function select(el){curIconUrl=el.src;curNatural=[el.naturalWidth||32,el.naturalHeight||32];[...div.children].forEach(c=>c.style.outline='none');el.style.outline='2px solid #0f0';}
      });
      return div;}}
    );
    map.addControl(new IconPalette());

    /* ---------- –°–æ–∑–¥–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–æ–≤ ---------- */
    map.on('pm:create',async e=>{
      const l=e.layer;

      // --- –ó–æ–Ω—ã ---
      if(l instanceof L.Circle||l instanceof L.Polygon){
        const col=await pickColor('#ff0000');
        l.setStyle({color:col,fillColor:col,fillOpacity:0.3});
        saveProps(l,{color:col});
        return;
      }

      // --- –ú–∞—Ä–∫–µ—Ä—ã ---
      if(l instanceof L.Marker){
        // –†–∞–∑–º–µ—Ä –∏–∫–æ–Ω–∫–∏
        let size=[...curNatural];
        const w=prompt('–®–∏—Ä–∏–Ω–∞ –∏–∫–æ–Ω–∫–∏ (px, Enter = –æ—Ä–∏–≥–∏–Ω–∞–ª):','');
        const h=prompt('–í—ã—Å–æ—Ç–∞ –∏–∫–æ–Ω–∫–∏ (px, Enter = –æ—Ä–∏–≥–∏–Ω–∞–ª):','');
        if(w&&h){size=[parseInt(w)||size[0],parseInt(h)||size[1]];}
        l.setIcon(L.icon({iconUrl:curIconUrl,iconSize:size,iconAnchor:[size[0]/2,size[1]]}));

        // –ü–æ–¥–ø–∏—Å—å
        const label=prompt('–¢–µ–∫—Å—Ç –ø–æ–¥–ø–∏—Å–∏ (Enter ‚Äî –±–µ–∑ –ø–æ–¥–ø–∏—Å–∏):','');
        let col='#ffffff',fsize='14',stroke='2';
        if(label){
          col   =await pickColor('#ffffff');
          fsize =prompt('–†–∞–∑–º–µ—Ä —Ç–µ–∫—Å—Ç–∞ (px):','14')||'14';
          stroke=prompt('–¢–æ–ª—â–∏–Ω–∞ –±–µ–ª–æ–π –æ–±–≤–æ–¥–∫–∏ (px, 0 = –±–µ–∑):','2')||'0';
          l.bindTooltip(label,{permanent:true,direction:'center',className:'label-no-bg',opacity:1,offset:[0,size[1]/2]}).openTooltip();
          styleTooltip(l.getTooltip(),col,fsize,stroke);
        }
        saveProps(l,{icon:curIconUrl,iconW:size[0],iconH:size[1],label,labelColor:col,labelSize:fsize,labelStroke:stroke});
      }
    });

    /* ---------- –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–≥–æ JSON ---------- */
    fetch('data/features.json').then(r=>r.ok?r.json():null).then(data=>{if(!data)return;L.geoJSON(data,{
      pointToLayer:(f,latlng)=>{
        if(f.properties&&f.properties.icon){const s=[f.properties.iconW||32,f.properties.iconH||32];return L.marker(latlng,{icon:L.icon({iconUrl:f.properties.icon,iconSize:s,iconAnchor:[s[0]/2,s[1]]})});}
        return L.marker(latlng);
      },
      onEachFeature:(f,l)=>{
        if(f.properties){
          if(l.setStyle&&f.properties.color){l.setStyle({color:f.properties.color,fillColor:f.properties.color,fillOpacity:0.3});}
          if(l instanceof L.Marker&&f.properties.label){const h=f.properties.iconH||32;l.bindTooltip(f.properties.label,{permanent:true,direction:'center',className:'label-no-bg',opacity:1,offset:[0,h/2]}).openTooltip();styleTooltip(l.getTooltip(),f.properties.labelColor,f.properties.labelSize,f.properties.labelStroke);}
        }
      }
    }).addTo(map);});

    /* ---------- –ö–Ω–æ–ø–∫–∞ ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å¬ª ---------- */
    L.control({position:'topleft'}).onAdd=()=>{const d=L.DomUtil.create('div','leaflet-bar leaflet-control');d.innerHTML='<a href="#" title="–°–∫–∞—á–∞—Ç—å features.json">üíæ</a>';d.style.cursor='pointer';d.onclick=e=>{e.preventDefault();downloadJSON(L.featureGroup(L.PM.Utils.findLayers(map)).toGeoJSON());};return d;};

    /* ===== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ===== */
    function styleTooltip(tt,color,size,stroke){const el=tt&&tt.getElement?tt.getElement():null;if(!el)return;if(color)el.style.color=color;if(size)el.style.fontSize=size+'px';if(stroke&&parseInt(stroke)>0){el.style.webkitTextStroke=`${stroke}px #fff`;}else{el.style.webkitTextStroke='';}el.style.textShadow='0 0 2px #000';}
    function saveProps(layer,props){layer.feature=layer.feature||{type:'Feature',properties:{}};Object.assign(layer.feature.properties,props);}
    function downloadJSON(obj){const blob=new Blob([JSON.stringify(obj,null,2)],{type:'application/json'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='features.json';document.body.append
