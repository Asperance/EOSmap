<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>EOS Map ‚Äî —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <!-- Leaflet‚ÄëGeoman -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@geoman-io/leaflet-geoman-free@2.15.0/dist/leaflet-geoman.css" />

  <style>
    html,body,#map{height:100%;margin:0;background:#111}
    .leaflet-container{background:#111}
    .label-no-bg{background:transparent!important;border:none!important;padding:0!important;pointer-events:none;}
  </style>
</head>
<body>
<div id="map"></div>

<!-- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/@geoman-io/leaflet-geoman-free@2.15.0/dist/leaflet-geoman.min.js" defer></script>
<script defer>
window.addEventListener('load',()=>{
  /* === –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã === */
  const MAP_IMG  = 'img/map.png';
  const ICON_SRC = 'img/icons.json';

  /* –¶–≤–µ—Ç–æ–≤–∞—è –ø–∞–ª–∏—Ç—Ä–∞ */
  function pickColor(def='#ffffff'){
    return new Promise(r=>{
      const i=Object.assign(document.createElement('input'),{type:'color',value:def,style:'position:fixed;left:-999px'});
      document.body.appendChild(i);
      i.oninput=()=>{r(i.value);i.remove();};
      i.click();
    });
  }

  /* –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –∏–∫–æ–Ω–æ–∫ ‚Üí –∑–∞–ø—É—Å–∫–∞–µ–º –∫–∞—Ä—Ç—É */
  fetch(ICON_SRC).then(r=>r.ok?r.json():[]).then(list=>init(list)).catch(()=>init([]));

  function init(iconList){
    const img=new Image();
    img.onload=()=>buildMap(img,iconList);
    img.src=MAP_IMG;
  }

  function buildMap(img,icons){
    const bounds=[[0,0],[img.naturalHeight,img.naturalWidth]];
    const map=L.map('map',{crs:L.CRS.Simple,minZoom:-5,maxZoom:2});
    L.imageOverlay(MAP_IMG,bounds).addTo(map);
    map.fitBounds(bounds);map.setMaxBounds(bounds);

    // ===== –ü–∞–Ω–µ–ª—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è =====
    map.pm.addControls({position:'topleft',drawMarker:true,drawCircle:true,drawPolygon:true,editMode:true,dragMode:true,removalMode:true});

    /* --- –ü–∞–ª–∏—Ç—Ä–∞ –∏–∫–æ–Ω–æ–∫ --- */
    let curUrl='',curSize=[32,32];
    if(icons.length){
      const Palette=L.Control.extend({options:{position:'topright'},onAdd(){
        const box=L.DomUtil.create('div','leaflet-bar leaflet-control');
        box.style.cssText='background:#222;padding:4px;max-height:160px;overflow-y:auto';
        icons.forEach(f=>{
          const im=new Image();im.src='img/'+f;im.style.cssText='width:24px;height:24px;margin:2px;cursor:pointer';
          im.onload=()=>{if(!curUrl)select(im);};
          im.onclick=()=>select(im);
          box.appendChild(im);
        });
        function select(im){curUrl=im.src;curSize=[im.naturalWidth||32,im.naturalHeight||32];[...box.children].forEach(c=>c.style.outline='none');im.style.outline='2px solid #0f0';}
        return box;
      }});
      map.addControl(new Palette());
    }

    /* --- –°–æ–∑–¥–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–æ–≤ --- */
    map.on('pm:create',async e=>{
      const l=e.layer;
      // –ó–æ–Ω–∞
      if(l instanceof L.Circle||l instanceof L.Polygon){
        const col=await pickColor('#ff0000');
        l.setStyle({color:col,fillColor:col,fillOpacity:0.3});
        save(l,{color:col});
        return;
      }
      // –ú–∞—Ä–∫–µ—Ä
      if(l instanceof L.Marker){
        let sz=[...curSize];
        const w=prompt('–®–∏—Ä–∏–Ω–∞ –∏–∫–æ–Ω–∫–∏ (px, Enter = –æ—Ä–∏–≥–∏–Ω–∞–ª):','');
        const h=prompt('–í—ã—Å–æ—Ç–∞ –∏–∫–æ–Ω–∫–∏ (px, Enter = –æ—Ä–∏–≥–∏–Ω–∞–ª):','');
        if(w&&h){sz=[+w||sz[0],+h||sz[1]];}
        l.setIcon(L.icon({iconUrl:curUrl,iconSize:sz,iconAnchor:[sz[0]/2,sz[1]]}));
        const txt=prompt('–¢–µ–∫—Å—Ç –ø–æ–¥–ø–∏—Å–∏ (Enter ‚Äî –±–µ–∑ –ø–æ–¥–ø–∏—Å–∏):','');
        let col='#fff',fs='14',st='2';
        if(txt){col=await pickColor('#ffffff');fs=prompt('–†–∞–∑–º–µ—Ä —Ç–µ–∫—Å—Ç–∞ (px):','14')||'14';st=prompt('–¢–æ–ª—â–∏–Ω–∞ –æ–±–≤–æ–¥–∫–∏ (px, 0=–±–µ–∑):','2')||'0';
          l.bindTooltip(txt,{permanent:true,direction:'center',className:'label-no-bg',offset:[0,sz[1]/2]}).openTooltip();
          styleTip(l.getTooltip(),col,fs,st);
        }
        save(l,{icon:curUrl,iconW:sz[0],iconH:sz[1],label:txt,labelColor:col,labelSize:fs,labelStroke:st});
      }
    });

    /* --- –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö --- */
    fetch('data/features.json').then(r=>r.ok?r.json():null).then(g=>{if(!g)return;L.geoJSON(g,{pointToLayer:(f,latlng)=>{
      if(f.properties&&f.properties.icon){const s=[f.properties.iconW||32,f.properties.iconH||32];return L.marker(latlng,{icon:L.icon({iconUrl:f.properties.icon,iconSize:s,iconAnchor:[s[0]/2,s[1]]})});}
      return L.marker(latlng);},onEachFeature:(f,l)=>{
        if(f.properties&&f.properties.color&&l.setStyle){l.setStyle({color:f.properties.color,fillColor:f.properties.color,fillOpacity:0.3});}
        if(l instanceof L.Marker&&f.properties&&f.properties.label){const h=f.properties.iconH||32;l.bindTooltip(f.properties.label,{permanent:true,direction:'center',className:'label-no-bg',offset:[0,h/2]}).openTooltip();styleTip(l.getTooltip(),f.properties.labelColor,f.properties.labelSize,f.properties.labelStroke);}  
      }}).addTo(map);});

    /* --- –ö–Ω–æ–ø–∫–∞ ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å¬ª --- */
    L.control({position:'topleft'}).onAdd=()=>{const d=L.DomUtil.create('div','leaflet-bar leaflet-control');d.innerHTML='<a href="#" title="–°–∫–∞—á–∞—Ç—å features.json">üíæ</a>';d.style.cursor='pointer';d.onclick=e=>{e.preventDefault();download(L.featureGroup(L.PM.Utils.findLayers(map)).toGeoJSON());};return d;};

    /* === styleTip: —á–∏—Å—Ç–∞—è –≤–Ω–µ—à–Ω—è—è –æ–±–≤–æ–¥–∫–∞ === */
    function styleTip(tt,c,s,st){
      const el=tt&&tt.getElement?tt.getElement():null; if(!el) return;
      if(c) el.style.color=c;
      if(s) el.style.fontSize=s+'px';
      const w=parseInt(st,10)||0;
      el.style.textShadow=w>0?[
        `${-w}px ${-w}px 0 #fff`, `${w}px ${-w}px 0 #fff`,
        `${-w}px ${w}px 0 #fff`,  `${w}px ${w}px 0 #fff`
      ].join(','):'none';
    }

    /* === –•–µ–ª–ø–µ—Ä—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è === */
    function save(l,p){l.feature=l.feature||{type:'Feature',properties:{}};Object.assign(l.feature.properties,p);}  
    function download(obj){const blob=new Blob([JSON.stringify(obj,null,2)],{type:'application/json'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='features.json';document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(url);}  
  }
});
</script>
</body>
</html>
