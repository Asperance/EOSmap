<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>EOS Map (edit mode)</title>

  <!-- Leaflet core -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <!-- Leaflet-Geoman -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@geoman-io/leaflet-geoman-free@2.15.0/dist/leaflet-geoman.css" />

  <style>
    html,body,#map{height:100%;margin:0;background:#111}
    .leaflet-container{background:#111}
    .label-no-bg{background:transparent!important;border:none!important;padding:0!important;pointer-events:none;}
  </style>
</head>
<body>
<div id="map"></div>

<!-- JS libs -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/@geoman-io/leaflet-geoman-free@2.15.0/dist/leaflet-geoman.min.js" defer></script>
<script defer>
window.addEventListener('load', () => {
  const imgSrc = 'img/map.png';
  const iconManifest = 'img/icons.json';   // —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤-–∏–∫–æ–Ω–æ–∫

  /* === –ó–∞—Ä–∞–Ω–µ–µ –ø–æ–¥–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∏–∫–æ–Ω–æ–∫ === */
  let iconList = [];
  fetch(iconManifest)
    .then(r=>r.ok?r.json():[])
    .then(arr=>{ iconList = Array.isArray(arr)?arr:[]; })
    .catch(()=>{});

  /* === –ü–æ–¥–ª–æ–∂–∫–∞-–∫–∞—Ä—Ç–∞ === */
  const img = new Image();
  img.onload = () => {
    const W = img.naturalWidth;
    const H = img.naturalHeight;
    const bounds = [[0,0],[H,W]];

    const map = L.map('map', { crs:L.CRS.Simple,minZoom:-5,maxZoom:2,zoomSnap:0.5 });
    L.imageOverlay(imgSrc, bounds).addTo(map);
    map.fitBounds(bounds);
    map.zoomIn(1);
    map.setMaxBounds(bounds);

    /* === Geoman –ø–∞–Ω–µ–ª—å === */ /*–∫–æ–º–º–µ–Ω—Ç–∏–º –µ—Å–ª–∏ –ø–µ—Ä–µ–≤–æ–¥–∏–º –∫–∞—Ä—Ç—É –≤ —Ä–µ–∂–∏–º –ø—Ä–æ—Å–º–æ—Ç—Ä–∞*/
    map.pm.addControls({position:'topleft',drawMarker:true,drawCircle:true,drawPolygon:true,editMode:true,dragMode:true,removalMode:true});

    /* === Palette of icons (top‚Äëright) === */
    let selectedIconUrl = '';
    const IconPalette = L.Control.extend({
      onAdd: function(){
        const div = L.DomUtil.create('div','leaflet-bar leaflet-control');
        div.style.background = '#222';
        div.style.padding = '4px';
        div.style.maxHeight = '160px';
        div.style.overflowY = 'auto';
        const build = () => {
          div.innerHTML='';
          iconList.forEach(file=>{
            const img=document.createElement('img');
            img.src='img/'+file;
            img.style.width='24px';
            img.style.height='24px';
            img.style.margin='2px';
            img.style.cursor='pointer';
            img.onclick=()=>{
              selectedIconUrl = 'img/'+file;
              [...div.children].forEach(c=>c.style.outline='none');
              img.style.outline='2px solid #0f0';
            };
            div.appendChild(img);
          });
        };
        build();
        return div;
      }
    });
    map.addControl(new IconPalette({position:'topright'}));

    /* === –°–æ–∑–¥–∞–Ω–∏–µ —Å–ª–æ—ë–≤ === */
    map.on('pm:create', e => {
      const layer = e.layer;

      // ---- –ó–æ–Ω—ã ----
      if(layer instanceof L.Circle || layer instanceof L.Polygon){
        const color = prompt('–¶–≤–µ—Ç –∑–æ–Ω—ã (HEX):', '#ff0000');
        if(color) layer.setStyle({color, fillColor:color, fillOpacity:0.3});
        layer.feature = layer.feature || {type:'Feature', properties:{}};
        layer.feature.properties.color = color;
      }

      // ---- –ú–∞—Ä–∫–µ—Ä—ã ----
      if(layer instanceof L.Marker){
        // –ø—Ä–∏–º–µ–Ω—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –∏–∫–æ–Ω–∫—É, –µ—Å–ª–∏ –µ—Å—Ç—å
        if(selectedIconUrl){
          const ic = L.icon({iconUrl:selectedIconUrl, iconSize:[32,32], iconAnchor:[16,32]});
          layer.setIcon(ic);
        }
        const label = prompt('–¢–µ–∫—Å—Ç –º–µ—Ç–∫–∏ (Enter ‚Äî –±–µ–∑ –ø–æ–¥–ø–∏—Å–∏):', '');
        let txtColor = '#ffffff', txtSize='14';
        if(label){
          txtColor = prompt('–¶–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞ (HEX):', '#ffffff');
          txtSize  = prompt('–†–∞–∑–º–µ—Ä —Ç–µ–∫—Å—Ç–∞ (px):', '14');
          layer.bindTooltip(label,{permanent:true,direction:'center',className:'label-no-bg',opacity:1}).openTooltip();
          const el = layer.getTooltip().getElement();
          if(el){ el.style.color = txtColor; el.style.fontSize = txtSize+'px'; }
        }
        layer.feature = layer.feature || {type:'Feature', properties:{}};
        Object.assign(layer.feature.properties, {
          icon: selectedIconUrl || undefined,
          label,
          labelColor: txtColor,
          labelSize:  txtSize
        });
      }
    });

    /* === –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ === */
    fetch('data/features.json').then(r=>r.ok?r.json():null).then(gj=>{
      if(!gj) return;
      L.geoJSON(gj, {
        pointToLayer:(f,latlng)=>{
          if(f.properties && f.properties.icon){
            return L.marker(latlng,{icon:L.icon({iconUrl:f.properties.icon,iconSize:[32,32],iconAnchor:[16,32]})});
          }
          return L.marker(latlng);
        },
        onEachFeature:(f,l)=>{
          if(f.properties){
            if(l.setStyle && f.properties.color){
              l.setStyle({color:f.properties.color,fillColor:f.properties.color,fillOpacity:0.3});
            }
            if(l instanceof L.Marker && f.properties.label){
              l.bindTooltip(f.properties.label,{permanent:true,direction:'center',className:'label-no-bg',opacity:1}).openTooltip();
              const el=l.getTooltip().getElement();
              if(el){
                if(f.properties.labelColor) el.style.color=f.properties.labelColor;
                if(f.properties.labelSize)  el.style.fontSize=f.properties.labelSize+'px';
              }
            }
          }
        }
      }).eachLayer(l=>l.addTo(map));
    });

    /* === –ö–Ω–æ–ø–∫–∞ üíæ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å === */
    const saveCtrl = L.control({position:'topleft'});
    saveCtrl.onAdd = () => {
      const div = L.DomUtil.create('div','leaflet-bar leaflet-control');
      div.innerHTML = '<a href="#" title="Save GeoJSON">üíæ</a>';
      div.style.cursor='pointer';
      div.onclick = e => {
        e.preventDefault();
        const collection = L.featureGroup(L.PM.Utils.findLayers(map)).toGeoJSON();
        const blob = new Blob([JSON.stringify(collection,null,2)], {type:'application/json'});
        const url=URL.createObjectURL(blob);
        const a=document.createElement('a');
        a.href=url;a.download='features.json';a.style.display='none';
        document.body.appendChild(a);a.click();document.body.removeChild(a);
        URL.revokeObjectURL(url);
      };
      return div;
    };
    saveCtrl.addTo(map);
  };
  img.onerror=()=>console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å', imgSrc);
  img.src=imgSrc;
});
</script>
</body>
</html>
