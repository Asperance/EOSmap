<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>EOS Map</title>

  <!-- Leaflet core -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <!-- Leaflet-Geoman: стабильный CDN jsDelivr -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@geoman-io/leaflet-geoman-free@2.15.0/dist/leaflet-geoman.css" />

  <style>
    html,body,#map{height:100%;margin:0}
  </style>
</head>
<body>
<div id="map"></div>

<!-- JS libs -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@geoman-io/leaflet-geoman-free@2.15.0/dist/leaflet-geoman.min.js"></script>

<script>
  // Относительный путь к файлу карты
  const imgSrc = 'img/map.png';

  // Динамически определяем размеры PNG, чтобы не прописывать вручную
  const img = new Image();
  img.onload = () => {
    const WIDTH  = img.naturalWidth;
    const HEIGHT = img.naturalHeight;
    const bounds = [[0,0],[HEIGHT,WIDTH]];  // CRS.Simple [y,x]

    const map = L.map('map', {
      crs: L.CRS.Simple,
      minZoom: -5,
      maxZoom: 2,
      zoomSnap: 0.5
    });

    L.imageOverlay(imgSrc, bounds).addTo(map);
    map.fitBounds(bounds);
    map.setMaxBounds(bounds);

    // Проверяем доступность Geoman
    if (map.pm) {
      map.pm.addControls({
        position: 'topleft',
        drawMarker: true,
        drawCircle: true,
        drawPolygon: true,
        editMode: true,
        removalMode: true
      });

      const dump = () => {
        const gj = L.PM.Utils.findLayers(map).toGeoJSON();
        console.log('GeoJSON:', JSON.stringify(gj, null, 2));
      };
      map.on('pm:create pm:edit pm:remove', dump);
    } else {
      console.error('Leaflet-Geoman не загрузился — проверьте ссылки на CDN.');
    }
  };
  img.onerror = () => console.error('Не удалось загрузить картинку карты по пути', imgSrc);
  img.src = imgSrc;
</script>
</body>
</html>
