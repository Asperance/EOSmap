<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>EOS Map (—Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)</title>
  
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <!-- Leaflet‚ÄëGeoman -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@geoman-io/leaflet-geoman-free@2.15.0/dist/leaflet-geoman.css" />
  
  <style>
    html,body,#map{height:100%;margin:0;background:#111}
    .leaflet-container{background:#111}
    .label-no-bg{background:transparent!important;border:none!important;padding:0!important;pointer-events:none;}
  </style>
</head>
<body>
<div id="map"></div>

<!-- –°–∫—Ä–∏–ø—Ç—ã -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/@geoman-io/leaflet-geoman-free@2.15.0/dist/leaflet-geoman.min.js" defer></script>
<script defer>
window.addEventListener('load', () => {
  /* ========== –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ========== */
  const MAP_IMG       = 'img/map.png';      // –ø–æ–¥–ª–æ–∂–∫–∞
  const ICON_MANIFEST = 'img/icons.json';   // —Å–ø–∏—Å–æ–∫ –∏–∫–æ–Ω–æ–∫

  /* –ü–∞–ª–∏—Ç—Ä–∞ —Ü–≤–µ—Ç–æ–≤ —á–µ—Ä–µ–∑ native input[type=color] */
  const pickColor = (def='#ffffff') => new Promise(r=>{
    const i=Object.assign(document.createElement('input'),{type:'color',value:def,style:'position:fixed;left:-999px'});
    document.body.appendChild(i);
    i.addEventListener('input',()=>{r(i.value);document.body.removeChild(i);});
    i.click();
  });

  /* –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –∏–∫–æ–Ω–æ–∫ */
  let icons=[];
  fetch(ICON_MANIFEST).then(r=>r.ok?r.json():[]).then(arr=>icons=arr).catch(()=>{});

  /* –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É‚Äë–ø–æ–¥–ª–æ–∂–∫—É */
  const img=new Image();
  img.onload=()=>init(img);
  img.src=MAP_IMG;

  function init(img){
    const bounds=[[0,0],[img.naturalHeight,img.naturalWidth]];
    const map=L.map('map',{crs:L.CRS.Simple,minZoom:-5,maxZoom:2});
    L.imageOverlay(MAP_IMG,bounds).addTo(map);
    map.fitBounds(bounds);
    map.setMaxBounds(bounds);

    // ===== –†–µ–¥–∞–∫—Ç–æ—Ä =====  (–∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ —Å—Ç—Ä–æ–∫—É –¥–ª—è —Ä–µ–∂–∏–º–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞)
    map.pm.addControls({position:'topleft',drawMarker:true,drawCircle:true,drawPolygon:true,editMode:true,dragMode:true,removalMode:true});

    /* ------ –ü–∞–ª–∏—Ç—Ä–∞ –∏–∫–æ–Ω–æ–∫ ------ */
    let curUrl='',curSize=[32,32];
    // --- –ü–∞–ª–∏—Ç—Ä–∞ –∏–∫–æ–Ω–æ–∫ –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω—ã–π –∫–ª–∞—Å—Å ---
const IconPalette = L.Control.extend({
  options: { position: 'topright' },
  onAdd() {
    const d = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
    d.style.cssText = 'background:#222;padding:4px;max-height:160px;overflow-y:auto';

    icons.forEach(file => {
      const im = new Image();
      im.src = 'img/' + file;
      im.style.cssText = 'width:24px;height:24px;margin:2px;cursor:pointer;';
      im.onload = () => { if (!curUrl) select(im); };
      im.onclick = () => select(im);
      d.appendChild(im);
    });

    function select(im) {
      curUrl = im.src;
      curSize = [im.naturalWidth || 32, im.naturalHeight || 32];
      [...d.children].forEach(c => c.style.outline = 'none');
      im.style.outline = '2px solid #0f0';
    }

    return d;
  }
});
map.addControl(new IconPalette());

    /* ------ –°–æ–∑–¥–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–æ–≤ ------ */
    map.on('pm:create',async ev=>{
      const l=ev.layer;
      if(l instanceof L.Circle||l instanceof L.Polygon){
        const c=await pickColor('#ff0000');
        l.setStyle({color:c,fillColor:c,fillOpacity:0.3});
        save(l,{color:c});
        return;
      }
      if(l instanceof L.Marker){
        let sz=[...curSize];
        const w=prompt('–®–∏—Ä–∏–Ω–∞ –∏–∫–æ–Ω–∫–∏ (px, Enter = –æ—Ä–∏–≥–∏–Ω–∞–ª):','');
        const h=prompt('–í—ã—Å–æ—Ç–∞ –∏–∫–æ–Ω–∫–∏ (px, Enter = –æ—Ä–∏–≥–∏–Ω–∞–ª):','');
        if(w&&h){sz=[+w||sz[0],+h||sz[1]];}
        l.setIcon(L.icon({iconUrl:curUrl,iconSize:sz,iconAnchor:[sz[0]/2,sz[1]]}));
        const label=prompt('–¢–µ–∫—Å—Ç –ø–æ–¥–ø–∏—Å–∏ (Enter ‚Äî –±–µ–∑ –ø–æ–¥–ø–∏—Å–∏):','');
        let col='#fff',fsz='14',strk='2';
        if(label){col=await pickColor('#ffffff');fsz=prompt('–†–∞–∑–º–µ—Ä —Ç–µ–∫—Å—Ç–∞ (px):','14')||'14';strk=prompt('–¢–æ–ª—â–∏–Ω–∞ –±–µ–ª–æ–π –æ–±–≤–æ–¥–∫–∏ (px, 0 = –±–µ–∑):','2')||'0';
          l.bindTooltip(label,{permanent:true,direction:'center',className:'label-no-bg',offset:[0,sz[1]/2]}).openTooltip();
          style(l.getTooltip(),col,fsz,strk);
        }
        save(l,{icon:curUrl,iconW:sz[0],iconH:sz[1],label,labelColor:col,labelSize:fsz,labelStroke:strk});
      }
    });

    /* ------ –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–≥–æ GeoJSON ------ */
    fetch('data/features.json').then(r=>r.ok?r.json():null).then(g=>{if(!g)return;L.geoJSON(g,{pointToLayer:(f,latlng)=>{
      if(f.properties&&f.properties.icon){const s=[f.properties.iconW||32,f.properties.iconH||32];return L.marker(latlng,{icon:L.icon({iconUrl:f.properties.icon,iconSize:s,iconAnchor:[s[0]/2,s[1]]})});}
      return L.marker(latlng);},onEachFeature:(f,l)=>{
        if(f.properties&&l instanceof L.Marker&&f.properties.label){const h=f.properties.iconH||32;l.bindTooltip(f.properties.label,{permanent:true,direction:'center',className:'label-no-bg',offset:[0,h/2]}).openTooltip();style(l.getTooltip(),f.properties.labelColor,f.properties.labelSize,f.properties.labelStroke);}if(l.setStyle&&f.properties&&f.properties.color){l.setStyle({color:f.properties.color,fillColor:f.properties.color,fillOpacity:0.3});}}}).addTo(map);});

    /* ------ –ö–Ω–æ–ø–∫–∞ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å" ------ */
    L.control({position:'topleft'}).onAdd=()=>{const d=L.DomUtil.create('div','leaflet-bar leaflet-control');d.innerHTML='<a href="#" title="–°–∫–∞—á–∞—Ç—å features.json">üíæ</a>';d.style.cursor='pointer';d.onclick=e=>{e.preventDefault();download(L.featureGroup(L.PM.Utils.findLayers(map)).toGeoJSON());};return d;};

    /* === –£—Ç–∏–ª–∏—Ç—ã === */
    function style(tt,c,s,st){const el=tt&&tt.getElement?tt.getElement():null;if(!el)return;if(c)el.style.color=c;if(s)el.style.fontSize=s+'px';el.style.webkitTextStroke=st&&+st>0?`${st}px #fff`:'';el.style.textShadow='0 0 2px #000';}
    function save(l,props){l.feature=l.feature||{type:'Feature',properties:{}};Object.assign(l.feature.properties,props);}    
    function download(obj){const blob=new Blob([JSON.stringify(obj,null,2)],{type:'application/json'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='features.json';document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(url);}  
  }
});
</script>
</body>
</html>
