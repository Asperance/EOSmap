<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>EOS Map ‚Äî —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <!-- Leaflet‚ÄëGeoman -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@geoman-io/leaflet-geoman-free@2.15.0/dist/leaflet-geoman.css" />

  <style>
    html,body,#map{height:100%;margin:0;background:#111}
    .leaflet-container{background:#111}
    .label-no-bg{background:transparent!important;border:none!important;padding:0!important;pointer-events:none;}
  </style>
</head>
<body>
<div id="map"></div>

<!-- –°–∫—Ä–∏–ø—Ç—ã -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/@geoman-io/leaflet-geoman-free@2.15.0/dist/leaflet-geoman.min.js" defer></script>
<script defer>
window.addEventListener('load',()=>{
  /* ===== –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã ===== */
  const MAP_IMG='img/map.png';              // –ø–æ–¥–ª–æ–∂–∫–∞

  /* ===== –£—Ç–∏–ª–∏—Ç–∞ –≤—ã–±–æ—Ä–∞ —Ü–≤–µ—Ç–∞ ===== */
  function pickColor(def='#ffffff'){
    return new Promise(res=>{
      const inp=Object.assign(document.createElement('input'),{type:'color',value:def,style:'position:fixed;left:-999px'});
      document.body.appendChild(inp);
      inp.oninput=()=>{res(inp.value);inp.remove();};
      inp.click();
    });
  }

  /* ===== –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–¥–ª–æ–∂–∫—É –∫–∞—Ä—Ç—ã –∏ –∑–∞–ø—É—Å–∫–∞–µ–º ===== */
  const img=new Image();
  img.onload=()=>init(img);
  img.src=MAP_IMG;

  function init(img){
    const bounds=[[0,0],[img.naturalHeight,img.naturalWidth]];
    const map=L.map('map',{crs:L.CRS.Simple,minZoom:-5,maxZoom:2});
    L.imageOverlay(MAP_IMG,bounds).addTo(map);
    map.fitBounds(bounds);
    map.setMaxBounds(bounds);

    // === –ü–∞–Ω–µ–ª—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è  (–∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –¥–ª—è —Ä–µ–∂–∏–º–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞) ===
    map.pm.addControls({position:'topleft',drawMarker:true,drawCircle:true,drawPolygon:true,editMode:true,dragMode:true,removalMode:true});

    /* ===== –°–æ–∑–¥–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–æ–≤ ===== */
    map.on('pm:create',async ev=>{
      const l=ev.layer;

            /* --- –ó–æ–Ω–∞ (–∫—Ä—É–≥/–ø–æ–ª–∏–≥–æ–Ω) --- */
      if(l instanceof L.Circle || l instanceof L.Polygon){
        let col = prompt('HEX —Ü–≤–µ—Ç –∑–æ–Ω—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä #ff0000):', '#ff0000');
        if(!col || !/^#?[0-9a-fA-F]{6}$/.test(col)) col = '#ff0000';
        if(col[0] !== '#') col = '#' + col;
        l.setStyle({color:col,fillColor:col,fillOpacity:0.3});
        save(l,{color:col});
        return;
      }
      }

      /* --- –ú–∞—Ä–∫–µ—Ä --- */
      if(l instanceof L.Marker){
        // 1. –ò–∫–æ–Ω–∫–∞
        const file=prompt('–ò–º—è —Ñ–∞–π–ª–∞ –∏–∫–æ–Ω–∫–∏ (–∏–∑ –ø–∞–ø–∫–∏ img/):','marker.png');
        let szW=parseInt(prompt('–®–∏—Ä–∏–Ω–∞ –∏–∫–æ–Ω–∫–∏ (px):','32'))||32;
        let szH=parseInt(prompt('–í—ã—Å–æ—Ç–∞ –∏–∫–æ–Ω–∫–∏ (px):','32'))||32;
        const iconUrl='img/'+file;
        l.setIcon(L.icon({iconUrl,iconSize:[szW,szH],iconAnchor:[szW/2,szH]}));

        // 2. –ü–æ–¥–ø–∏—Å—å
        const txt=prompt('–¢–µ–∫—Å—Ç –ø–æ–¥–ø–∏—Å–∏ (Enter ‚Äî –±–µ–∑ –ø–æ–¥–ø–∏—Å–∏):','');
        let txtSize='14';
        if(txt){ txtSize=prompt('–†–∞–∑–º–µ—Ä —Ç–µ–∫—Å—Ç–∞ (px):','14')||'14';
          l.bindTooltip(txt,{permanent:true,direction:'center',className:'label-no-bg',offset:[0,szH/2]}).openTooltip();
          styleTip(l.getTooltip(),txtSize);
        }
        save(l,{icon:iconUrl,iconW:szW,iconH:szH,label:txt,labelSize:txtSize});
      }
    });

    /* ===== –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö ===== */
    fetch('data/features.json').then(r=>r.ok?r.json():null).then(g=>{if(!g)return;L.geoJSON(g,{
      pointToLayer:(f,latlng)=>{
        if(f.properties&&f.properties.icon){const s=[f.properties.iconW||32,f.properties.iconH||32];return L.marker(latlng,{icon:L.icon({iconUrl:f.properties.icon,iconSize:s,iconAnchor:[s[0]/2,s[1]]})});}
        return L.marker(latlng);
      },
      onEachFeature:(f,l)=>{
        if(f.properties&&f.properties.color&&l.setStyle){l.setStyle({color:f.properties.color,fillColor:f.properties.color,fillOpacity:0.3});}
        if(l instanceof L.Marker&&f.properties&&f.properties.label){const h=f.properties.iconH||32;l.bindTooltip(f.properties.label,{permanent:true,direction:'center',className:'label-no-bg',offset:[0,h/2]}).openTooltip();styleTip(l.getTooltip(),f.properties.labelSize);}  
      }
    }).addTo(map);});

    /* ===== –ö–Ω–æ–ø–∫–∞ ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å¬ª ===== */
    L.control({position:'topleft'}).onAdd=()=>{const d=L.DomUtil.create('div','leaflet-bar leaflet-control');d.innerHTML='<a href="#" title="–°–∫–∞—á–∞—Ç—å features.json">üíæ</a>';d.style.cursor='pointer';d.onclick=e=>{e.preventDefault();downloadJSON(L.featureGroup(L.PM.Utils.findLayers(map)).toGeoJSON());};return d;};

    /* ===== –í–Ω–µ—à–Ω—è—è –±–µ–ª–∞—è –æ–±–≤–æ–¥–∫–∞ ===== */
    function styleTip(tt,size){
      const el=tt&&tt.getElement?tt.getElement():null; if(!el) return;
      const px=parseInt(size)||14;
      el.style.fontSize=px+'px';
      const w=2; // –∂—ë—Å—Ç–∫–∞—è –≤–Ω–µ—à–Ω—è—è –æ–±–≤–æ–¥–∫–∞ 2px
      el.style.textShadow=[
        `${-w}px ${-w}px 0 #fff`, `${w}px ${-w}px 0 #fff`,
        `${-w}px ${w}px 0 #fff`,  `${w}px ${w}px 0 #fff`
      ].join(',');
    }

    function save(l,p){l.feature=l.feature||{type:'Feature',properties:{}};Object.assign(l.feature.properties,p);}  
    function downloadJSON(obj){const blob=new Blob([JSON.stringify(obj,null,2)],{type:'application/json'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='features.json';document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(url);}  
  }
});
</script>
</body>
</html>
