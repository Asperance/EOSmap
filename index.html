<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>EOS Map ‚Äî —Ä–µ–¥–∞–∫—Ç–æ—Ä</title>

  <!-- Leaflet core -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <!-- Leaflet-Geoman -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@geoman-io/leaflet-geoman-free@2.15.0/dist/leaflet-geoman.css">

  <style>
    html,body,#map{height:100%;margin:0;background:#111}
    .leaflet-container{background:#111}
    .label-no-bg{background:transparent!important;border:none!important;padding:0!important;pointer-events:none;white-space:nowrap}
    .icon-box{background:#222;padding:4px;max-height:160px;overflow-y:auto}
    .icon-box img{width:24px;height:24px;margin:2px;cursor:pointer}
    .icon-box img.sel{outline:2px solid #0f0}
  </style>
</head>
<body>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/@geoman-io/leaflet-geoman-free@2.15.0/dist/leaflet-geoman.min.js" defer></script>
<script defer>
/* ==== –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ ==== */
const MAP_IMG    = 'img/map.png';
const ICONS_JSON = 'img/icons.json';
const STROKE_PX  = 2;         /* —Ç–æ–ª—â–∏–Ω–∞ –±–µ–ª–æ–π –æ–±–≤–æ–¥–∫–∏ */

/* ==== –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –º–∞—Å—Å–∏–≤—ã ==== */
let baseZoom = 0;
const labels  = [];           // –ø–æ–¥–ø–∏—Å–∏: {el, baseSize}
const markers = [];           // –º–∞—Ä–∫–µ—Ä—ã: {layer, baseW, baseH}
let curIcon   = {url:'', w:32, h:32};

/* ==== –∑–∞–≥—Ä—É–∑–∫–∞ –ø–æ–¥–ª–æ–∂–∫–∏ –∏ —Å–ø–∏—Å–∫–∞ –∏–∫–æ–Ω–æ–∫ ==== */
const img = new Image();
img.onload = () =>
  fetch(ICONS_JSON).then(r=>r.ok?r.json():[]).then(list=>init(img,list))
                   .catch(()=>init(img,[]));
img.src = MAP_IMG;

/* ==== –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã ==== */
function init(img, iconList){
  const bounds=[[0,0],[img.naturalHeight,img.naturalWidth]];
  const map=L.map('map',{crs:L.CRS.Simple,minZoom:-5,maxZoom:2});
  baseZoom = map.getZoom();
  L.imageOverlay(MAP_IMG,bounds).addTo(map);
  map.fitBounds(bounds);
  map.setMaxBounds(bounds);

  /* --- –ø–∞–Ω–µ–ª—å –≥–µ–æ–º–∞–Ω --- */
  map.pm.addControls({
    position:'topleft',
    drawMarker:true, drawCircle:true, drawPolygon:true,
    editMode:true,  dragMode:true,   removalMode:true
  });

  /* --- –ø–∞–ª–∏—Ç—Ä–∞ –∏–∫–æ–Ω–æ–∫ --- */
  if(iconList.length){
    const Palette=L.Control.extend({
      options:{position:'topright'},
      onAdd(){
        const box=L.DomUtil.create('div','leaflet-bar leaflet-control icon-box');
        iconList.forEach(f=>{
          const im=new Image();
          im.src='img/'+f;
          im.onload=()=>{ if(!curIcon.url) select(im); };
          im.onclick=()=>select(im);
          box.appendChild(im);
        });
        function select(im){
          curIcon={url:im.src, w:im.naturalWidth||32, h:im.naturalHeight||32};
          [...box.children].forEach(c=>c.classList.remove('sel'));
          im.classList.add('sel');
        }
        return box;
      }
    });
    map.addControl(new Palette());
  }

  /* --- —Å–æ–∑–¥–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–æ–≤ --- */
  map.on('pm:create', async ev=>{
    const l=ev.layer;

    /* –∑–æ–Ω—ã */
    if(l instanceof L.Circle || l instanceof L.Polygon){
      let col = prompt('HEX —Ü–≤–µ—Ç –∑–æ–Ω—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä ff0000):','#ff0000');
      if(!/^#?[0-9a-fA-F]{6}$/.test(col||'')) col='#ff0000';
      if(col[0]!=='#') col='#'+col;
      l.setStyle({color:col,fillColor:col,fillOpacity:0.3});
      save(l,{color:col});
      return;
    }

    /* –º–∞—Ä–∫–µ—Ä—ã */
    if(l instanceof L.Marker){
      /* —Ä–∞–∑–º–µ—Ä—ã –∏–∫–æ–Ω–∫–∏ */
      let w = +prompt('–®–∏—Ä–∏–Ω–∞ –∏–∫–æ–Ω–∫–∏ (px):',curIcon.w)||curIcon.w;
      let h = +prompt('–í—ã—Å–æ—Ç–∞ –∏–∫–æ–Ω–∫–∏ (px):',curIcon.h)||curIcon.h;
      l.setIcon(L.icon({iconUrl:curIcon.url,iconSize:[w,h],iconAnchor:[w/2,h]}));
      markers.push({layer:l, baseW:w, baseH:h});

      /* –ø–æ–¥–ø–∏—Å—å */
      const txt = prompt('–¢–µ–∫—Å—Ç –ø–æ–¥–ø–∏—Å–∏ (Enter = –±–µ–∑):','');
      if(txt){
        const txtSize = prompt('–†–∞–∑–º–µ—Ä —Ç–µ–∫—Å—Ç–∞ (px):','14')||'14';
        let txtColor = prompt('HEX —Ü–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä ffffff):','#ffffff')||'#ffffff';
        if(txtColor[0]!=='#') txtColor='#'+txtColor;
        if(!/^#?[0-9a-fA-F]{6}$/.test(txtColor)) txtColor='#ffffff';
        l.bindTooltip(txt,{permanent:true,direction:'center',className:'label-no-bg',offset:[0,h/2]}).openTooltip();
        styleTooltip(l.getTooltip(),txtSize,txtColor);
        save(l,{icon:curIcon.url,iconW:w,iconH:h,label:txt,labelSize:txtSize,labelColor:txtColor});
      }else{
        save(l,{icon:curIcon.url,iconW:w,iconH:h});
      }
    }
  });

  /* --- –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –∏ –∏–∫–æ–Ω–æ–∫ --- */
  map.on('zoomend',()=>{
    const k = Math.pow(2,map.getZoom()-baseZoom);
    /* –ø–æ–¥–ø–∏—Å–∏ */
    labels.forEach(o=>{
      o.el.style.fontSize = (o.baseSize*k)+'px';
      o.el.style.webkitTextStroke = (STROKE_PX*k)+'px #fff';
    });
    /* –∏–∫–æ–Ω–∫–∏ */
    markers.forEach(m=>{
      const nw=m.baseW*k, nh=m.baseH*k;
      m.layer.setIcon(L.icon({iconUrl:m.layer.options.icon.options.iconUrl,iconSize:[nw,nh],iconAnchor:[nw/2,nh]}));
      const tt=m.layer.getTooltip();
      if(tt){ tt.options.offset=[0,nh/2]; tt._updatePosition(); }
    });
  });

  /* --- –∑–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö —Å–ª–æ—ë–≤ --- */
  fetch('data/features.json').then(r=>r.ok?r.json():null).then(gj=>{
    if(!gj) return;
    L.geoJSON(gj,{
      pointToLayer:(f,latlng)=>{
        if(f.properties&&f.properties.icon){
          const s=[f.properties.iconW||32,f.properties.iconH||32];
          const mk=L.marker(latlng,{icon:L.icon({iconUrl:f.properties.icon,iconSize:s,iconAnchor:[s[0]/2,s[1]]})});
          markers.push({layer:mk,baseW:s[0],baseH:s[1]});
          return mk;
        }
        return L.marker(latlng);
      },
      onEachFeature:(f,l)=>{
        if(f.properties&&f.properties.color&&l.setStyle){
          l.setStyle({color:f.properties.color,fillColor:f.properties.color,fillOpacity:0.3});
        }
        if(l instanceof L.Marker && f.properties && f.properties.label){
          const h=f.properties.iconH||32;
          l.bindTooltip(f.properties.label,{permanent:true,direction:'center',className:'label-no-bg',offset:[0,h/2]}).openTooltip();
          styleTooltip(l.getTooltip(),f.properties.labelSize,f.properties.labelColor);
        }
      }
    }).addTo(map);
  });

  /* --- –∫–Ω–æ–ø–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è --- */
  const Save=L.Control.extend({options:{position:'topleft'},onAdd(){
    const d=L.DomUtil.create('div','leaflet-bar leaflet-control');
    d.innerHTML='<a href=\"#\" title=\"–°–∫–∞—á–∞—Ç—å features.json\">üíæ</a>';
    d.style.cursor='pointer';
    d.onclick=e=>{
      e.preventDefault();
      const blob=new Blob([JSON.stringify(L.featureGroup(L.PM.Utils.findLayers(map)).toGeoJSON(),null,2)],{type:'application/json'});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a');a.href=url;a.download='features.json';a.click();URL.revokeObjectURL(url);
    };
    return d;
  }});
  map.addControl(new Save());

  /* --- helpers --- */
  function styleTooltip(tt,size,col){
    const el=tt&&tt.getElement?tt.getElement():null; if(!el) return;
    const px=parseInt(size)||14;
    el.style.fontSize=px+'px';
    el.style.color=col;
    el.style.webkitTextStroke=STROKE_PX+'px #fff';
    labels.push({el,baseSize:px});
  }
  function save(layer,props){ layer.feature=layer.feature||{type:'Feature',properties:{}}; Object.assign(layer.feature.properties,props); }
}
</script>
</body>
</html>
