<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>EOS Map (edit mode)</title>

  <!-- Leaflet core -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <!-- Leaflet‚ÄëGeoman ‚Üí —Å—Ç–∞–±–∏–ª—å–Ω—ã–π –¥–∏—Å—Ç—Ä–∏–±—É—Ç–∏–≤ –Ω–∞ jsDelivr 2.15.0 -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@geoman-io/leaflet-geoman-free@2.15.0/dist/leaflet-geoman.css" />

  <style>
    html,body,#map{height:100%;margin:0;background:#111}
    .leaflet-container{background:#111}
  </style>
</head>
<body>
<div id="map"></div>

<!-- JS libs -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@geoman-io/leaflet-geoman-free@2.15.0/dist/leaflet-geoman.min.js"></script>

<script>
  // –ü—É—Ç—å –∫ –ø–æ–¥–ª–æ–∂–∫–µ –∫–∞—Ä—Ç—ã
  const imgSrc = 'img/map.png';

  // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, —É–∑–Ω–∞—ë–º —Ä–∞–∑–º–µ—Ä—ã -> –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É
  const img = new Image();
  img.onload = () => {
    const W = img.naturalWidth;
    const H = img.naturalHeight;
    const bounds = [[0,0],[H,W]];

    const map = L.map('map', {
      crs: L.CRS.Simple,
      minZoom: -5,
      maxZoom: 2,
      zoomSnap: 0.5
    });

    L.imageOverlay(imgSrc, bounds).addTo(map);
    map.fitBounds(bounds);
    map.zoomIn(1);  // —Å—Ç–∞—Ä—Ç—É–µ–º —á—É—Ç—å –±–ª–∏–∂–µ
    map.setMaxBounds(bounds);

    /* === Leaflet‚ÄëGeoman === */
    if (!map.pm) {
      console.error('Geoman –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è ‚Äî –ø—Ä–æ–≤–µ—Ä—å—Ç–µ CDN');
      return;
    }

    map.pm.addControls({
      position: 'topleft',
      drawMarker: true,
      drawCircle: true,
      drawPolygon: true,
      editMode: true,
      dragMode: true,
      removalMode: true
    });

    /* –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–∞–Ω–µ–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã, –µ—Å–ª–∏ —Ñ–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç */
    fetch('data/features.json')
      .then(r => r.ok ? r.json() : null)
      .then(gj => {
        if (gj) L.geoJSON(gj).eachLayer(l => l.addTo(map));
      })
      .catch(()=>{});

            /* === –ö–Ω–æ–ø–∫–∞ ¬´üíæ¬ª ‚Äî —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å GeoJSON === */
    const saveCtrl = L.control({position:'topleft'});
    saveCtrl.onAdd = () => {
      const div = L.DomUtil.create('div','leaflet-bar leaflet-control');
      div.innerHTML = '<a href="#" title="Save GeoJSON">üíæ</a>';
      div.style.cursor = 'pointer';
      div.onclick = e => {
        e.preventDefault();
                // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ —Å–ª–æ–∏, —Å–æ–∑–¥–∞–Ω–Ω—ã–µ Geoman, –≤ FeatureGroup
        const layers = L.PM.Utils.findLayers(map); // –º–∞—Å—Å–∏–≤ Leaflet‚Äë—Å–ª–æ—ë–≤
        const fg = L.featureGroup(layers);
        const collection = fg.toGeoJSON();

        // –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª features.json
        const blob = new Blob([JSON.stringify(collection, null, 2)], {type:'application/json'});
        const url  = URL.createObjectURL(blob);
        const a    = document.createElement('a');
        a.href = url;
        a.download = 'features.json';
        a.style.display='none';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);(url);
      };
      return div;
    };
    saveCtrl.addTo(map);
  };
  img.onerror = () => console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å', imgSrc);
  img.src = imgSrc;
</script>
</body>
</html>
