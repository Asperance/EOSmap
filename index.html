<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>EOS Map ‚Äî —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <!-- Leaflet‚ÄëGeoman -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@geoman-io/leaflet-geoman-free@2.15.0/dist/leaflet-geoman.css" />

  <style>
    html,body,#map{height:100%;margin:0;background:#111}
    .leaflet-container{background:#111}
    .label-no-bg{background:transparent!important;border:none!important;padding:0!important;pointer-events:none;}
  </style>
</head>
<body>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/@geoman-io/leaflet-geoman-free@2.15.0/dist/leaflet-geoman.min.js" defer></script>
<script defer>
window.addEventListener('load',()=>{
  /* ===== –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã ===== */
  const MAP_IMG      = 'img/map.png';      // –ø–æ–¥–ª–æ–∂–∫–∞
  const ICONS_JSON   = 'img/icons.json';   // JSON‚Äë—Å–ø–∏—Å–æ–∫ –∏–∫–æ–Ω–æ–∫
  const STROKE_PX    = 1;                 // ### —Ç–æ–ª—â–∏–Ω–∞ –≤–Ω–µ—à–Ω–µ–π –æ–±–≤–æ–¥–∫–∏ ###

  /* ===== –ü–æ–¥–ª–æ–∂–∫–∞ ===== */
  const img = new Image();
  img.onload = () => fetch(ICONS_JSON).then(r=>r.ok?r.json():[]).then(list=>init(img,list)).catch(()=>init(img,[]));
  img.src = MAP_IMG;

  function init(img, icons){
    const bounds=[[0,0],[img.naturalHeight,img.naturalWidth]];
    const map=L.map('map',{crs:L.CRS.Simple,minZoom:-5,maxZoom:2});
    L.imageOverlay(MAP_IMG,bounds).addTo(map);
    map.fitBounds(bounds);map.setMaxBounds(bounds);

    // === –ü–∞–Ω–µ–ª—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è ===
    map.pm.addControls({position:'topleft',drawMarker:true,drawCircle:true,drawPolygon:true,editMode:true,dragMode:true,removalMode:true});

    /* ===== –ü–∞–ª–∏—Ç—Ä–∞ –∏–∫–æ–Ω–æ–∫ ===== */
    let curIconUrl='',curNatural=[32,32];
    if(icons.length){
      const Palette=L.Control.extend({options:{position:'topright'},onAdd(){
        const box=L.DomUtil.create('div','leaflet-bar leaflet-control');
        box.style.cssText='background:#222;padding:4px;max-height:160px;overflow-y:auto';
        icons.forEach(f=>{
          const im=new Image();im.src='img/'+f;im.style.cssText='width:24px;height:24px;margin:2px;cursor:pointer';
          im.onload=()=>{if(!curIconUrl) select(im);} ;
          im.onclick=()=>select(im);
          box.appendChild(im);
        });
        function select(im){
          curIconUrl=im.src;
          curNatural=[im.naturalWidth||32,im.naturalHeight||32];
          [...box.children].forEach(c=>c.style.outline='none');
          im.style.outline='2px solid #0f0';
        }
        return box;
      }});
      map.addControl(new Palette());
    }

    /* ===== –°–æ–∑–¥–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–æ–≤ ===== */
    map.on('pm:create',async ev=>{
      const l=ev.layer;

      // ---- –ó–û–ù–ê ----
      if(l instanceof L.Circle||l instanceof L.Polygon){
        let col=prompt('HEX —Ü–≤–µ—Ç –∑–æ–Ω—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä #ff0000):','#ff0000');
        if(!/^#?[0-9a-fA-F]{6}$/.test(col||'')) col='#ff0000';
        if(col[0]!=='#') col='#'+col;
        l.setStyle({color:col,fillColor:col,fillOpacity:0.3});
        save(l,{color:col});
        return;
      }

      // ---- –ú–ê–†–ö–ï–† ----
      if(l instanceof L.Marker){
        /* 1. –†–∞–∑–º–µ—Ä –∏–∫–æ–Ω–∫–∏ */
        let size=[...curNatural];
        const w=prompt('–®–∏—Ä–∏–Ω–∞ –∏–∫–æ–Ω–∫–∏ (px):',size[0]);
        const h=prompt('–í—ã—Å–æ—Ç–∞ –∏–∫–æ–Ω–∫–∏ (px):',size[1]);
        if(w&&h){size=[+w||size[0],+h||size[1]];}
        l.setIcon(L.icon({iconUrl:curIconUrl,iconSize:size,iconAnchor:[size[0]/2,size[1]]}));

        /* 2. –ü–æ–¥–ø–∏—Å—å */
        const txt=prompt('–¢–µ–∫—Å—Ç –ø–æ–¥–ø–∏—Å–∏ (Enter ‚Äî –±–µ–∑ –ø–æ–¥–ø–∏—Å–∏):','');
        let txtSize='14', txtColor='#ffffff';
        if(txt){
          txtSize = prompt('–†–∞–∑–º–µ—Ä —Ç–µ–∫—Å—Ç–∞ (px):','14') || '14';
          txtColor= prompt('HEX —Ü–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞ (#ffffff):','#ffffff') || '#ffffff';
          if(txtColor[0]!=='#') txtColor='#'+txtColor;
          if(!/^#?[0-9a-fA-F]{6}$/.test(txtColor)) txtColor='#ffffff';
          l.bindTooltip(txt,{permanent:true,direction:'center',className:'label-no-bg',offset:[0,size[1]/2]}).openTooltip();
          styleTooltip(l.getTooltip(),txtSize,txtColor);
        }
        save(l,{icon:curIconUrl,iconW:size[0],iconH:size[1],label:txt,labelSize:txtSize,labelColor:txtColor});
      }
    });

    /* ===== –ó–∞–≥—Ä—É–∑–∫–∞ GeoJSON ===== */
    fetch('data/features.json').then(r=>r.ok?r.json():null).then(g=>{if(!g)return;L.geoJSON(g,{pointToLayer:(f,latlng)=>{
      if(f.properties&&f.properties.icon){const s=[f.properties.iconW||32,f.properties.iconH||32];return L.marker(latlng,{icon:L.icon({iconUrl:f.properties.icon,iconSize:s,iconAnchor:[s[0]/2,s[1]]})});}
      return L.marker(latlng);},onEachFeature:(f,l)=>{
        if(f.properties&&f.properties.color&&l.setStyle){l.setStyle({color:f.properties.color,fillColor:f.properties.color,fillOpacity:0.3});}
        if(l instanceof L.Marker&&f.properties&&f.properties.label){const h=f.properties.iconH||32;l.bindTooltip(f.properties.label,{permanent:true,direction:'center',className:'label-no-bg',offset:[0,h/2]}).openTooltip();styleTooltip(l.getTooltip(),f.properties.labelSize,f.properties.labelColor);}  
      }}).addTo(map);});

    /* ===== –ö–Ω–æ–ø–∫–∞ ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å¬ª ===== */
    L.control({position:'topleft'}).onAdd=()=>{
      const d=L.DomUtil.create('div','leaflet-bar leaflet-control');
      d.innerHTML='<a href="#" title="–°–∫–∞—á–∞—Ç—å features.json">üíæ</a>';
      d.style.cursor='pointer';
      d.onclick=e=>{e.preventDefault();downloadJSON(L.featureCollection ? L.featureCollection(L.PM.Utils.findLayers(map)) : L.featureGroup(L.PM.Utils.findLayers(map)).toGeoJSON());};
      return d;
    };

    /* ===== –§—É–Ω–∫—Ü–∏–∏ ===== */
    function styleTooltip(tt,size,color){
      const el=tt&&tt.getElement?tt.getElement():null; if(!el) return;
      el.style.fontSize=(parseInt(size)||14)+'px';
      el.style.color=color||'#ffffff';
      el.style.webkitTextStroke=`${STROKE_PX}px #fff`;
    }
    function save(l,p){
      l.feature=l.feature||{type:'Feature',properties:{}};
      Object.assign(l.feature.properties,p);
    }
    function downloadJSON(obj){
      const blob=new Blob([JSON.stringify(obj,null,2)],{type:'application/json'});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a');
      a.href=url;a.download='features.json';
      document.body.appendChild(a);a.click();a.remove();
      URL.revokeObjectURL(url);
    }
  }
});
</script>
</body>
</html>
